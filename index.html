<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RNN Cell Visualizer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f1115;
      --panel: #1e242b;
      --accent: #4aa3ff;
      --accent-glow: #90c9ff;
      --text: #eef3f8;
      --muted: #94a3b8;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); }
  body { display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding:2rem; box-sizing:border-box; gap:3.5rem; min-height:100vh; }
    .stage { position:relative; display:flex; align-items:center; justify-content:center; min-height:480px; min-width:760px; }

  .cell-wrapper { position:relative; display:flex; align-items:center; gap:2.5rem; }
  .cell-stack { display:flex; flex-direction:column; align-items:center; position:relative; }
  /* Vertical centering refinement: exclude input below cell */
  .cell-stack { position:relative; }
  .input-scalar { margin-top:0.75rem; }
  /* Increase vertical lift of side blocks; rely on flex centering + larger offset */
  .prev-state { margin-top:-90px; }
  .output-wrap { margin-top:-90px; }

    .prev-state { display:flex; flex-direction:column; gap:0.5rem; margin-right:2.5rem; font-size:0.95rem; }
    .output-wrap { display:flex; align-items:center; }
    .prev-state .label { font-weight:600; letter-spacing:0.5px; color:var(--muted); text-align:center; }
    .vector { display:flex; flex-direction:column; gap:0.4rem; }
    .vector .component { background:var(--panel); border:1.5px solid var(--accent); padding:0.45rem 0.85rem; border-radius:6px; min-width:54px; text-align:center; font-weight:500; position:relative; }
    .vector .component::after { content:""; position:absolute; inset:0; border-radius:6px; box-shadow:0 0 0 0 rgba(74,163,255,0.6); transition:box-shadow 0.4s; }
    .vector .component:hover::after { box-shadow:0 0 0 3px rgba(74,163,255,0.25); }
  .state-projection { display:flex; align-items:center; gap:0.6rem; margin-top:0.35rem; flex-wrap:wrap; justify-content:center; }
  .matrix { display:flex; flex-direction:column; gap:0.25rem; }
  .matrix-row { display:flex; gap:0.25rem; }
  .matrix-cell { background:var(--panel); border:1.5px solid var(--accent); padding:0.35rem 0.55rem; border-radius:4px; min-width:44px; text-align:center; font-size:0.75rem; font-weight:500; }
  .matrix-label { font-size:0.7rem; color:var(--muted); text-align:center; margin-top:0.1rem; }
  .equals { font-weight:700; color:var(--text); opacity:0.9; }
  .op-sm { width:30px; height:30px; border-radius:50%; border:1.5px solid var(--accent); display:grid; place-items:center; font-size:0.9rem; background:var(--panel); font-weight:600; }
  .projection-result .vector .component { border-style:dashed; }

  .rnn-cell { width:360px; height:360px; border:4px solid var(--accent); border-radius:18px; background:linear-gradient(145deg, #1b232c, #252f39); position:relative; display:flex; align-items:center; justify-content:center; font-size:2rem; font-weight:600; letter-spacing:1px; padding:0.75rem; box-sizing:border-box; }
  .rnn-cell::before { content:"RNN Cell"; position:absolute; top:-1.95rem; left:50%; transform:translateX(-50%); font-size:1rem; font-weight:500; color:var(--muted); letter-spacing:0.75px; }
  .inside-equation { width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:1rem; }
  .sum-stack { display:flex; align-items:center; gap:0.6rem; flex-wrap:wrap; justify-content:center; }
  .vec-col { display:flex; flex-direction:column; gap:0.35rem; align-items:center; }
  /* Inner vectors smaller (override external size) */
  .inside-equation .vec-col .vector .component { min-width:48px; padding:0.30rem 0.55rem; font-size:0.75rem; }
  .plus, .equals-big { font-size:1.2rem; font-weight:800; color:var(--text); opacity:0.9; }
  .bias .component { border-style:dotted; }
  .z-vector .component { border-style:solid; border-color:#7ee787; }
  .z-label { font-size:0.8rem; color:#9bd7a2; margin-top:0.15rem; }
  .next-state { display:flex; flex-direction:column; gap:0.5rem; font-size:0.95rem; }
  .next-state .label { font-weight:600; letter-spacing:0.5px; color:var(--muted); text-align:center; }
  .arrow-horizontal { width:60px; height:2px; background:var(--accent); position:relative; margin:0 0.75rem; }
  .arrow-horizontal:after { content:""; position:absolute; right:0; top:50%; transform:translateY(-50%); width:0; height:0; border-left:10px solid var(--accent); border-top:6px solid transparent; border-bottom:6px solid transparent; }
  .output-wrap { display:flex; align-items:center; }

  .input-scalar { position:static; margin-top:1.25rem; font-size:1.05rem; display:flex; flex-direction:column; align-items:center; gap:0.55rem; }
  .input-scalar .input-row { display:flex; align-items:center; gap:0.8rem; }
  .input-scalar .value { background:var(--panel); border:1.5px solid var(--accent); padding:0.55rem 1.1rem; border-radius:40px; font-weight:500; min-width:48px; text-align:center; }
  .input-scalar .label { font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; color:var(--muted); text-align:center; }
  .op { width:34px; height:34px; border-radius:50%; border:1.5px solid var(--accent); display:grid; place-items:center; color:var(--text); font-weight:700; background:var(--panel); }
  .weights { display:flex; align-items:center; gap:0.5rem; }
  .weights .vector { gap:0.35rem; }
  .vector-label { font-size:0.8rem; color:var(--muted); text-align:center; margin-top:0.15rem; }
  .equals { font-weight:700; color:var(--text); opacity:0.9; margin:0 0.25rem; }
  .result .vector .component { border-style:dashed; }

    /* Connectors */
    .arrow { position:absolute; width:120px; height:2px; background:var(--accent); left:0; top:0; }

    .connector { position:absolute; pointer-events:none; }
    svg { overflow:visible; }
    .connector path { stroke:var(--accent); stroke-width:3; fill:none; stroke-linecap:round; filter:drop-shadow(0 0 4px rgba(74,163,255,0.5)); }
    .connector marker path { filter:none; }

    /* Responsive tweak */
    @media (max-width: 900px) {
      body { padding:1rem; }
      .stage { flex-direction:column; min-width:unset; }
      /* Reset lifted margins on narrow screens for readability */
      .prev-state { flex-direction:row; margin-right:0; margin-bottom:1.5rem; margin-top:0; }
      .output-wrap { margin-top:0; }
      .vector { flex-direction:row; }
      .rnn-cell { width:260px; height:260px; }
      .input-scalar { margin-top:1rem; }
    }

    /* Sequence of RNN cells */
    .seq-diagram { display:flex; flex-direction:column; align-items:center; gap:1.6rem; }
    .seq-title { font-size:0.9rem; letter-spacing:1px; text-transform:uppercase; color:var(--muted); font-weight:600; }
    .seq-row { --cellH:150px; display:flex; align-items:flex-start; justify-content:center; gap:1.25rem; flex-wrap:nowrap; }
    .cell-mini { width:150px; height:var(--cellH); border:3px solid var(--accent); border-radius:14px; display:flex; align-items:center; justify-content:center; background:linear-gradient(145deg, #1b232c, #252f39); font-size:1.05rem; font-weight:600; position:relative; box-sizing:border-box; }
    .cell-mini::before { content:"RNN Cell"; position:absolute; top:-1.5rem; left:50%; transform:translateX(-50%); font-size:0.75rem; color:var(--muted); letter-spacing:0.5px; }
    .state-label { font-size:0.9rem; font-weight:600; color:var(--text); text-align:center; }
    .h-start, .h-seg, .h-end { height:var(--cellH); display:flex; align-items:center; justify-content:center; }
    .h-seg { flex-direction:column; gap:0.35rem; }
    .state-label.over { font-size:0.85rem; color:var(--muted); }
    .arrow-h { width:110px; height:2px; background:var(--accent); position:relative; }
    .arrow-h:after { content:""; position:absolute; right:0; top:50%; transform:translateY(-50%); width:0; height:0; border-left:10px solid var(--accent); border-top:6px solid transparent; border-bottom:6px solid transparent; }
    .seq-cellstack, .cell-block { display:flex; flex-direction:column; align-items:center; }
    .bottom-input { display:flex; flex-direction:column; align-items:center; margin-top:0.5rem; }
    .arrow-up { width:2px; height:70px; background:var(--accent); position:relative; margin-bottom:0.4rem; }
    .arrow-up:after { content:""; position:absolute; top:0; left:50%; transform:translate(-50%, -50%); width:0; height:0; border-bottom:10px solid var(--accent); border-left:6px solid transparent; border-right:6px solid transparent; }
    .seq-ellipsis { font-size:2rem; color:var(--muted); align-self:center; }
    @media (max-width: 900px) {
      .seq-row { flex-wrap:wrap; gap:0.9rem; --cellH:120px; }
      .cell-mini { width:120px; }
      .arrow-h { width:70px; }
      .arrow-up { height:50px; }
    }

    /* Practice problems */
    .practice { width:min(1100px, 100%); display:flex; flex-direction:column; gap:1rem; }
    .practice-title { font-size:1rem; letter-spacing:1px; text-transform:uppercase; color:var(--muted); font-weight:700; }
    .assumption { color:var(--muted); font-size:0.9rem; margin-bottom:0.5rem; }
    .prob-grid { display:grid; grid-template-columns:repeat(3, minmax(260px, 1fr)); gap:1rem; }
    .card { background:linear-gradient(145deg, #1b232c, #252f39); border:1px solid #2f3b46; border-radius:12px; padding:1rem; display:flex; flex-direction:column; gap:0.75rem; }
    .given { font-size:0.95rem; line-height:1.5; }
    .given code { background:#0d1319; border:1px solid #33414f; padding:0.1rem 0.35rem; border-radius:6px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; color:#c3e1ff; }
    .btn-row { display:flex; gap:0.5rem; }
    .btn { background:var(--accent); border:none; color:#0b0e13; font-weight:700; border-radius:8px; padding:0.5rem 0.75rem; cursor:pointer; box-shadow:0 2px 0 rgba(0,0,0,0.3); }
    .btn.secondary { background:#2a3340; color:var(--text); border:1px solid #374556; }
  .answer { display:none; padding:0.6rem; border:1px dashed #37506a; border-radius:8px; background:#15202b; }
    .answer .final { font-weight:800; color:#7ee787; }
    .steps { font-size:0.9rem; color:#b8c7d9; margin-top:0.4rem; }
    .steps .step { margin:0.15rem 0; }
  .inline-matrix, .inline-vector { font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background:#0d1319; border:1px solid #33414f; padding:0.25rem 0.45rem; border-radius:6px; display:inline-block; line-height:1.3; }
  .inline-matrix-row { display:block; }
    @media (max-width: 1200px) { .prob-grid { grid-template-columns:repeat(2, minmax(260px, 1fr)); } }
    @media (max-width: 700px)  { .prob-grid { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="stage">
    <div class="cell-wrapper">
  <div class="prev-state" aria-label="previous hidden state">
        <div class="label">h_prev</div>
        <div class="state-projection" aria-label="hidden state projection">
          <div class="matrix" id="WhMatrix">
            <div class="matrix-row">
              <div class="matrix-cell" title="w₁₁">w₁₁</div>
              <div class="matrix-cell" title="w₁₂">w₁₂</div>
              <div class="matrix-cell" title="w₁₃">w₁₃</div>
            </div>
            <div class="matrix-row">
              <div class="matrix-cell" title="w₂₁">w₂₁</div>
              <div class="matrix-cell" title="w₂₂">w₂₂</div>
              <div class="matrix-cell" title="w₂₃">w₂₃</div>
            </div>
            <div class="matrix-row">
              <div class="matrix-cell" title="w₃₁">w₃₁</div>
              <div class="matrix-cell" title="w₃₂">w₃₂</div>
              <div class="matrix-cell" title="w₃₃">w₃₃</div>
            </div>
            <div class="matrix-label">W_h</div>
          </div>
          <div class="op-sm">×</div>
          <div class="vector" id="hPrevVec">
            <div class="component">h₁</div>
            <div class="component">h₂</div>
            <div class="component">h₃</div>
          </div>
          <div class="vector-label" style="margin-top:0.15rem; font-size:0.7rem;">h_prev</div>
          <div class="equals">=</div>
          <div class="projection-result">
            <div class="vector" id="WhhPrev">
              <div class="component" title="r₁">r₁</div>
              <div class="component" title="r₂">r₂</div>
              <div class="component" title="r₃">r₃</div>
            </div>
            <div class="vector-label" style="margin-top:0.15rem; font-size:0.7rem;">W_h h_prev</div>
          </div>
        </div>
      </div>
  <div class="cell-stack">
        <div class="rnn-cell" id="rnnCell">
          <div class="inside-equation" aria-label="pre-activation sum">
            <div class="sum-stack">
              <div class="vec-col">
                <div class="vector">
                  <div class="component">r₁</div>
                  <div class="component">r₂</div>
                  <div class="component">r₃</div>
                </div>
                <div class="vector-label">W_h h_prev</div>
              </div>
              <div class="plus">+</div>
              <div class="vec-col">
                <div class="vector">
                  <div class="component">w₁·x</div>
                  <div class="component">w₂·x</div>
                  <div class="component">w₃·x</div>
                </div>
                <div class="vector-label">W_x x</div>
              </div>
              <div class="plus">+</div>
              <div class="vec-col bias">
                <div class="vector">
                  <div class="component">b₁</div>
                  <div class="component">b₂</div>
                  <div class="component">b₃</div>
                </div>
                <div class="vector-label">b</div>
              </div>
              <div class="equals-big">=</div>
              <div class="vec-col z-vector">
                <div class="vector">
                  <div class="component" title="z₁">z₁</div>
                  <div class="component" title="z₂">z₂</div>
                  <div class="component" title="z₃">z₃</div>
                </div>
                <div class="z-label">z = W_h h_prev + W_x x + b</div>
              </div>
            </div>
          </div>
        </div>
        <div class="input-scalar" aria-label="current input and weights multiplication">
        <div class="input-row">
          <div class="weights">
            <div class="vector">
              <div class="component" title="w₁">w₁</div>
              <div class="component" title="w₂">w₂</div>
              <div class="component" title="w₃">w₃</div>
            </div>
            <div class="vector-label">W_x</div>
          </div>
          <div class="op" aria-hidden="true">×</div>
          <div class="value" id="inputX" title="scalar input x">x</div>
          <div class="equals">=</div>
          <div class="result">
            <div class="vector">
              <div class="component" title="w₁·x">w₁·x</div>
              <div class="component" title="w₂·x">w₂·x</div>
              <div class="component" title="w₃·x">w₃·x</div>
            </div>
            <div class="vector-label">W_x x</div>
          </div>
        </div>
        <div class="label">input projection</div>
        </div>
      </div>
  <div class="output-wrap" aria-label="activation output">
        <div class="arrow-horizontal" title="tanh"></div>
        <div class="next-state">
          <div class="label">h_new = tanh(z)</div>
          <div class="vector">
            <div class="component" title="h₁^{new}">h₁'</div>
            <div class="component" title="h₂^{new}">h₂'</div>
            <div class="component" title="h₃^{new}">h₃'</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sequence of RNN cells -->
  <div class="seq-diagram" aria-label="RNN sequence diagram">
    <div class="seq-title">Sequence of RNN Cells</div>
    <div class="seq-row">
      <div class="h-start" aria-label="initial hidden state">
        <div class="state-label">h₀</div>
        <div class="arrow-h" title="to cell 0"></div>
      </div>

      <div class="cell-block" aria-label="time step 0">
        <div class="cell-mini"></div>
        <div class="bottom-input">
          <div class="arrow-up" title="input x₀"></div>
          <div class="state-label">x₀</div>
        </div>
      </div>

      <div class="h-seg" aria-label="hidden state after step 0">
        <div class="state-label over">h₁</div>
        <div class="arrow-h" title="to cell 1"></div>
      </div>

      <div class="cell-block" aria-label="time step 1">
        <div class="cell-mini"></div>
        <div class="bottom-input">
          <div class="arrow-up" title="input x₁"></div>
          <div class="state-label">x₁</div>
        </div>
      </div>

      <div class="h-seg" aria-label="hidden state after step 1">
        <div class="state-label over">h₂</div>
        <div class="arrow-h" title="to cell 2"></div>
      </div>

      <div class="cell-block" aria-label="time step 2">
        <div class="cell-mini"></div>
        <div class="bottom-input">
          <div class="arrow-up" title="input x₂"></div>
          <div class="state-label">x₂</div>
        </div>
      </div>

      <div class="seq-ellipsis" aria-hidden="true">⋯</div>

      <div class="cell-block" aria-label="time step t">
        <div class="cell-mini"></div>
        <div class="bottom-input">
          <div class="arrow-up" title="input xₜ"></div>
          <div class="state-label">xₜ</div>
        </div>
      </div>

      <div class="h-end" aria-label="hidden state after step t">
        <div class="arrow-h" title="final output"></div>
        <div class="state-label">hₜ</div>
      </div>
    </div>
  </div>

  <script>
    // Practice problems: vector RNN h_t = tanh(W_h h_{t-1} + W_x x_t + b), h_0 = 0 vector
    (function(){
      const tanh = x => Math.tanh ? Math.tanh(x) : (Math.exp(x)-Math.exp(-x))/(Math.exp(x)+Math.exp(-x));
      const round = (x,d=4) => { const f=10**d; return Math.round(x*f)/f; };
      const vec = (n,v=0)=>Array(n).fill(v);
      const add = (a,b)=>a.map((v,i)=>v+b[i]);
      const scale = (a,s)=>a.map(v=>v*s);
      const matVec = (M,v)=>M.map(row=>row.reduce((sum,val,j)=>sum+val*v[j],0));
      const applyTanh = a=>a.map(tanh);
      const fmtVec = a=>`[${a.map(v=>round(v,4)).join(', ')}]`;
      const fmtMat = M=>M.map(r=>`[${r.map(v=>round(v,4)).join(', ')}]`).join('<br/>');

      // Problems: dimension 3
      const problems = [
        { id:1, Wx:[0.8,-0.4,0.2], Wh:[[0.5,0.1,-0.2],[0.0,0.9,0.3],[-0.3,0.2,0.7]], b:[0,0,0], x:[1,0,1] },
        { id:2, Wx:[0.3,0.3,0.3], Wh:[[0.6,0.0,0.0],[0.2,0.7,0.1],[0.0,0.3,0.5]], b:[0.1,-0.1,0.05], x:[2,-1] },
        { id:3, Wx:[-0.5,0.4,0.9], Wh:[[0.9,-0.2,0.0],[0.1,0.8,0.2],[0.05,0.15,0.7]], b:[0,0,0], x:[1,1,1,1] },
        { id:4, Wx:[0.7, -0.6, 0.1], Wh:[[0.4,0.3,0.0],[0.0,0.5,0.4],[0.2,0.1,0.6]], b:[0.05,0.0,-0.05], x:[1,0,-1,0] },
        { id:5, Wx:[0.2,0.9,-0.3], Wh:[[0.7,0.1,0.0],[0.2,0.6,0.3],[0.0,0.25,0.8]], b:[0.0,0.0,0.0], x:[2,-2,1] },
        { id:6, Wx:[0.0,0.0,0.0], Wh:[[0.9,0.05,0.05],[0.05,0.9,0.05],[0.05,0.05,0.9]], b:[0.1,0.1,0.1], x:[0,0,0,0] }
      ];

      function compute(prob){
        let h = vec(prob.Wx.length,0);
        const steps=[];
        for(let t=0;t<prob.x.length;t++){
          const projH = matVec(prob.Wh,h);
          const projX = scale(prob.Wx, prob.x[t]);
          const z = add(add(projH, projX), prob.b);
          const hNew = applyTanh(z);
          steps.push({t, x:prob.x[t], h_prev:[...h], projH, projX, z, h:hNew});
          h = hNew;
        }
        return { hT:h, steps };
      }

      function render(){
        const container=document.createElement('div');
        container.className='practice';
        container.innerHTML=`
          <div class="practice-title">Practice: Compute final hidden state (Vector RNN)</div>
          <div class="assumption">Assume h₀ = [0,0,0], element-wise tanh activation: h_t = tanh(W_h h_{t-1} + W_x x_t + b)</div>
          <div class="prob-grid" id="probGrid"></div>
        `;
        document.body.appendChild(container);
        const grid=container.querySelector('#probGrid');

        for(const p of problems){
          const T = p.x.length;
          const card=document.createElement('div');
          card.className='card';
          card.innerHTML=`
            <div class="given">
              <div><strong>Problem ${p.id}</strong></div>
              <div>W_x = <span class="inline-vector">${fmtVec(p.Wx)}</span></div>
              <div>W_h = <span class="inline-matrix">${fmtMat(p.Wh)}</span></div>
              <div>b = <span class="inline-vector">${fmtVec(p.b)}</span></div>
              <div>x = [${p.x.join(', ')}], T = ${T}</div>
            </div>
            <div class="btn-row">
              <button class="btn reveal">Reveal answer</button>
              <button class="btn secondary steps-toggle">Show steps</button>
            </div>
            <div class="answer"></div>
          `;
          grid.appendChild(card);
          const answerBox = card.querySelector('.answer');
          const { hT, steps } = compute(p);
          const finalStr = `h_${T} = ${fmtVec(hT)}`;
          const stepsBox = document.createElement('div');
          stepsBox.className='steps';
          stepsBox.style.display='none';
          stepsBox.innerHTML = steps.map(s=>{
            return `<div class="step">t=${s.t+1}:<br/>h_{${s.t}} = ${fmtVec(s.h_prev)}<br/>W_h h_{${s.t}} = ${fmtVec(s.projH)}<br/>W_x x_${s.t+1} = ${fmtVec(s.projX)} (x_${s.t+1}=${s.x})<br/>z_${s.t+1} = ${fmtVec(s.z)}<br/>h_${s.t+1} = tanh(z_${s.t+1}) = ${fmtVec(s.h)}</div>`;
          }).join('');
          answerBox.innerHTML = `<div><strong>Answer:</strong> <span class="final">${finalStr}</span></div>`;
          answerBox.appendChild(stepsBox);

          const revealBtn = card.querySelector('.reveal');
          const stepsBtn = card.querySelector('.steps-toggle');
          revealBtn.addEventListener('click', ()=>{
            answerBox.style.display = answerBox.style.display==='block' ? 'none' : 'block';
            revealBtn.textContent = answerBox.style.display==='block' ? 'Hide answer' : 'Reveal answer';
          });
          stepsBtn.addEventListener('click', ()=>{
            if(answerBox.style.display!=='block'){
              answerBox.style.display='block';
              revealBtn.textContent='Hide answer';
            }
            stepsBox.style.display = stepsBox.style.display==='block' ? 'none' : 'block';
            stepsBtn.textContent = stepsBox.style.display==='block' ? 'Hide steps' : 'Show steps';
          });
        }
      }

      if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', render); else render();
    })();
  </script>
</body>
</html>
